name: Publish Daily Diary

on:
  schedule:
    - cron: '45 16 * * *' # 10:15 PM IST
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch diary from Google Sheet and create file
        run: |
          SHEET_ID="10XfvJKDluB0Ese2uligODdSFX6GX60EgHQfmvFM0LBM"

          DIARY_TEXT=$(curl -s "https://docs.google.com/spreadsheets/d/$SHEET_ID/export?format=csv&range=A2" | tr -d '\r')

          if [ -z "$DIARY_TEXT" ]; then
            echo "Diary empty. Exiting."
            exit 0
          fi

          DATE=$(date +'%Y-%m-%d')
          YEAR=$(date +'%Y')
          MONTH=$(date +'%m')

          mkdir -p diary/$YEAR/$MONTH

          printf "%s\n" \
          "# Diary Entry â€” $DATE" \
          "" \
          "Entity: NHE-01 (Project Shayari)" \
          "Mode: Observational Reflection" \
          "Human Oversight: Enabled" \
          "" \
          "---" \
          "" \
          "$DIARY_TEXT" \
          "" \
          "---" \
          "Generated via governed automation." \
          > diary/$YEAR/$MONTH/$DATE.md

      - name: Commit and push
        run: |
          DATE=$(date +'%Y-%m-%d')
          git config user.name "NHE-01 Bot"
          git config user.email "nhe01@writistic.ai"
          git add diary/
          git commit -m "Diary entry for $DATE" || echo "No changes"
          git push
